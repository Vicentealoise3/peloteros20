<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>Strike Latino 2 - Tabla & Juegos</title>
Â  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
Â  <div class="container">
Â  Â  <h1>âš¾ PELOTEROS 20</h1>
Â  Â  <p class="subtitle">Tabla de posiciones y juegos del dÃ­a</p>

Â  Â  <!-- Barra de progreso -->
Â  Â  <div id="loading">
Â  Â  Â  <p id="loading-text">Cargando datos, por favor esperaâ€¦</p>
Â  Â  Â  <div id="progress-container">
Â  Â  Â  Â  <div id="progress-bar">0%</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Tabla -->
Â  Â  <section id="standings-section" class="hidden">
Â  Â  Â  <h2>ğŸ† Tabla de posiciones</h2>
Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  <table id="standings-table">
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th>Pos</th>
Â  Â  Â  Â  Â  Â  Â  <th>Equipo</th>
Â  Â  Â  Â  Â  Â  Â  <th>Jugador</th>
Â  Â  Â  Â  Â  Â  Â  <th>JJ</th>
Â  Â  Â  Â  Â  Â  Â  <th>W</th>
Â  Â  Â  Â  Â  Â  Â  <th>L</th>
Â  Â  Â  Â  Â  Â  Â  <th>P.Jugar</th>
Â  Â  Â  Â  Â  Â  Â  <th>Pts</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  <!-- Juegos de hoy -->
Â  Â  <section id="games-today" class="hidden">
Â  Â  Â  <h2>ğŸ“… Juegos jugados HOY (hora Chile)</h2>
Â  Â  Â  <ul id="games-list"></ul>
Â  Â  </section>

Â  Â  <!-- Errores -->
Â  Â  <div id="error" class="hidden"></div>
Â  </div>

Â  <script>
Â  Â  const bar = document.getElementById("progress-bar");
Â  Â  const loadingBox = document.getElementById("loading");
Â  Â  const loadingText = document.getElementById("loading-text");
Â  Â  const tbody = document.querySelector("#standings-table tbody");
Â  Â  const errorBox = document.getElementById("error");
Â  Â  const standingsSection = document.getElementById("standings-section");
Â  Â  const gamesTodayBox = document.getElementById("games-today");
Â  Â  const gamesList = document.getElementById("games-list");

Â  Â  let percent = 0;
Â  Â  let keepTicking = true;
Â  Â  let altInterval = null;

Â  Â  function setProgress(p, text) {
Â  Â  Â  percent = Math.max(0, Math.min(100, Math.floor(p)));
Â  Â  Â  bar.style.width = percent + "%";
Â  Â  Â  bar.textContent = percent + "%";
Â  Â  Â  if (text) loadingText.textContent = text;

Â  Â  Â  // Cuando llega a 99%, comenzar a alternar mensajes
Â  Â  Â  if (percent === 99 && !altInterval) {
Â  Â  Â  Â  let toggle = false;
Â  Â  Â  Â  altInterval = setInterval(() => {
Â  Â  Â  Â  Â  loadingText.textContent = toggle
Â  Â  Â  Â  Â  Â  ? "Consultando servidor..."
Â  Â  Â  Â  Â  Â  : "Falta poco, ten paciencia...";
Â  Â  Â  Â  Â  toggle = !toggle;
Â  Â  Â  Â  }, 2000);
Â  Â  Â  }

Â  Â  Â  // Si llega a 100%, detener alternancia
Â  Â  Â  if (percent === 100 && altInterval) {
Â  Â  Â  Â  clearInterval(altInterval);
Â  Â  Â  Â  altInterval = null;
Â  Â  Â  }
Â  Â  }

Â  Â  const ticker = setInterval(() => {
Â  Â  Â  if (!keepTicking) return;
Â  Â  Â  if (percent < 99) setProgress(percent + 1);
Â  Â  }, 120);

Â  Â  async function loadData() {
Â  Â  Â  try {
Â  Â  Â  Â  setProgress(5, "Consultando servidorâ€¦");

Â  Â  Â  Â  // Se ha quitado el 'cache: "no-store"' para que el navegador confÃ­e en el cachÃ© del servidor
Â  Â  Â  Â  const res = await fetch("/api/full");
Â  Â  Â  Â  if (!res.ok) throw new Error("Respuesta HTTP " + res.status);

Â  Â  Â  Â  setProgress(50, "Procesando datosâ€¦");
Â  Â  Â  Â  const data = await res.json();

Â  Â  Â  Â  // Tabla de posiciones
Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â  data.standings.forEach((r, idx) => {
Â  Â  Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  Â  <td>${idx + 1}</td>
Â  Â  Â  Â  Â  Â  <td><span class="team">${r.team}</span></td>
Â  Â  Â  Â  Â  Â  <td><span class="user">${r.user}</span></td>
Â  Â  Â  Â  Â  Â  <td>${r.played}</td>
Â  Â  Â  Â  Â  Â  <td>${r.wins}</td>
Â  Â  Â  Â  Â  Â  <td>${r.losses}</td>
Â  Â  Â  Â  Â  Â  <td>${r.remaining}</td>
Â  Â  Â  Â  Â  Â  <td><strong>${r.points}</strong></td>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  Â  });

Â  Â  Â  Â  // Juegos de hoy
Â  Â  Â  Â  gamesList.innerHTML = "";
Â  Â  Â  Â  if (data.games_today && data.games_today.length > 0) {
Â  Â  Â  Â  Â  data.games_today.forEach(g => {
Â  Â  Â  Â  Â  Â  const li = document.createElement("li");
Â  Â  Â  Â  Â  Â  li.innerHTML = `<span class="game-item">${g}</span>`;
Â  Â  Â  Â  Â  Â  gamesList.appendChild(li);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  gamesTodayBox.classList.remove("hidden");
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  const li = document.createElement("li");
Â  Â  Â  Â  Â  li.textContent = "â€” No hay registros hoy â€”";
Â  Â  Â  Â  Â  gamesList.appendChild(li);
Â  Â  Â  Â  Â  gamesTodayBox.classList.remove("hidden");
Â  Â  Â  Â  }

Â  Â  Â  Â  // Finalizar
Â  Â  Â  Â  keepTicking = false;
Â  Â  Â  Â  clearInterval(ticker);
Â  Â  Â  Â  setProgress(100, "Completado");
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  loadingBox.style.display = "none";
Â  Â  Â  Â  Â  standingsSection.classList.remove("hidden");
Â  Â  Â  Â  }, 200);

Â  Â  Â  } catch (err) {
Â  Â  Â  Â  keepTicking = false;
Â  Â  Â  Â  clearInterval(ticker);
Â  Â  Â  Â  setProgress(100, "Error");
Â  Â  Â  Â  errorBox.classList.remove("hidden");
Â  Â  Â  Â  errorBox.textContent = "No se pudieron cargar los datos: " + err.message;
Â  Â  Â  }
Â  Â  }

Â  Â  loadData();
Â  </script>
</body>
</html>
